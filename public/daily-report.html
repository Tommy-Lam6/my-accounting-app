<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ¯æ—¥æ¶ˆè²»è¨˜éŒ„ - æ™ºèƒ½è¨˜è³¬ç³»çµ±</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "DFKai-SB", "æ¨™æ¥·é«”", "Microsoft JhengHei", sans-serif;
        background: linear-gradient(135deg, #e8f4e8 0%, #c3e6c3 100%);
        padding: 20px;
        color: #2d5016;
        letter-spacing: 0.5px;
        line-height: 1.6;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e8 100%);
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(45, 80, 22, 0.2);
        border: 3px solid #8a6d3b;
        position: relative;
        overflow: hidden;
      }
      .container::before {
        content: "â˜¯";
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 28px;
        color: #8a6d3b;
        opacity: 0.3;
        transform: rotate(15deg);
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 3px solid #8a6d3b;
        position: relative;
      }
      .header::after {
        content: "";
        position: absolute;
        bottom: -3px;
        left: 0;
        width: 100px;
        height: 3px;
        background: linear-gradient(90deg, #2d5016, #8a6d3b);
        border-radius: 2px;
      }
      .header h1 {
        color: #2d5016;
        font-size: 32px;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
        padding-left: 40px;
      }
      .header h1::before {
        content: "é“";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        font-size: 36px;
        color: #8a6d3b;
        opacity: 0.8;
      }
      .controls {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 25px;
        background: rgba(255, 255, 255, 0.7);
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #8a6d3b;
      }
      .date-selector,
      .month-selector {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }
      .date-selector input,
      .month-selector input {
        padding: 10px 15px;
        border: 2px solid #8a6d3b;
        border-radius: 8px;
        font-size: 16px;
        font-family: "DFKai-SB", "æ¨™æ¥·é«”", "Microsoft JhengHei", sans-serif;
        background: #f9f9f9;
        transition: all 0.3s ease;
      }
      .date-selector input:focus,
      .month-selector input:focus {
        outline: none;
        border-color: #2d5016;
        background: white;
        box-shadow: 0 0 8px rgba(45, 80, 22, 0.2);
      }
      button {
        padding: 12px 20px;
        background: linear-gradient(135deg, #2d5016 0%, #4a7c3a 100%);
        color: #f1f8e9;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-family: "DFKai-SB", "æ¨™æ¥·é«”", "Microsoft JhengHei", sans-serif;
        font-weight: 600;
        box-shadow: 0 4px 8px rgba(45, 80, 22, 0.3);
        border: 1px solid #8a6d3b;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      button:hover {
        background: linear-gradient(135deg, #4a7c3a 0%, #2d5016 100%);
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(45, 80, 22, 0.4);
      }
      .btn-secondary {
        background: linear-gradient(135deg, #8a6d3b 0%, #a9925d 100%);
      }
      .btn-secondary:hover {
        background: linear-gradient(135deg, #a9925d 0%, #8a6d3b 100%);
      }

      .filter-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .filter-buttons button.active {
        background: linear-gradient(135deg, #2d5016 0%, #8a6d3b 100%);
        border: 2px solid #f1f8e9;
        transform: scale(1.05);
      }

      /* çµ±è¨ˆå¡ç‰‡ */
      .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
      }
      .stat-card {
        background: linear-gradient(135deg, #f8fdf8 0%, #f0f9f0 100%);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        border-left: 6px solid;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-top: 1px solid #8a6d3b;
        border-right: 1px solid #8a6d3b;
        border-bottom: 1px solid #8a6d3b;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #2d5016, #8a6d3b);
      }
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      }
      .stat-card.income {
        border-left-color: #2d5016;
      }
      .stat-card.fixed {
        border-left-color: #8a6d3b;
      }
      .stat-card.expense {
        border-left-color: #8b4513;
      }
      .stat-card.spending-total {
        border-left-color: #1565c0;
      }
      .stat-card.total {
        border-left-color: #2d5016;
      }
      .stat-card h3 {
        font-size: 16px;
        color: #5d4037;
        margin-bottom: 10px;
        font-weight: 600;
      }
      .stat-card .amount {
        font-size: 24px;
        font-weight: bold;
        color: #2d5016;
      }

      /* è¡¨æ ¼æ¨£å¼ */
      .transactions-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 25px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border: 2px solid #8a6d3b;
      }
      .transactions-table th,
      .transactions-table td {
        border: 1px solid #8a6d3b;
        padding: 15px;
        text-align: left;
        font-size: 16px;
      }
      .transactions-table th {
        background: linear-gradient(135deg, #2d5016 0%, #4a7c3a 100%);
        color: #f1f8e9;
        font-weight: 600;
        font-size: 18px;
        text-align: center;
      }
      .transactions-table tr:nth-child(even) {
        background: rgba(241, 248, 233, 0.5);
      }
      .transactions-table tr:hover {
        background: rgba(232, 245, 232, 0.8);
        transform: scale(1.01);
        transition: all 0.2s ease;
      }
      .type-badge {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: bold;
        font-family: "DFKai-SB", "æ¨™æ¥·é«”", "Microsoft JhengHei", sans-serif;
      }
      .type-income {
        background: linear-gradient(135deg, #d4efdf, #27ae60);
        color: #196f3d;
        border: 1px solid #27ae60;
      }
      .type-fixed {
        background: linear-gradient(135deg, #fdebd0, #e67e22);
        color: #a84300;
        border: 1px solid #e67e22;
      }
      .type-expense {
        background: linear-gradient(135deg, #fadbd8, #e74c3c);
        color: #922b21;
        border: 1px solid #e74c3c;
      }

      .empty-state {
        text-align: center;
        padding: 50px;
        color: #8a6d3b;
        font-size: 18px;
        font-style: italic;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 12px;
        border: 2px dashed #8a6d3b;
      }
      .back-btn {
        background: linear-gradient(135deg, #8a6d3b 0%, #a9925d 100%);
        margin-right: 15px;
      }

      /* æ­¦ç•¶æ´¾ç‰¹è‰²å…ƒç´  */
      .taoist-divider {
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #2d5016, #8a6d3b, #2d5016);
        border-radius: 2px;
        margin: 20px 0;
        position: relative;
        overflow: hidden;
      }

      .taoist-divider::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.4),
          transparent
        );
        animation: balanceFlow 3s infinite;
      }

      @keyframes balanceFlow {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      @media (max-width: 768px) {
        .controls {
          flex-direction: column;
          align-items: stretch;
        }
        .date-selector,
        .month-selector {
          justify-content: space-between;
        }
        .transactions-table {
          font-size: 14px;
        }
        .transactions-table th,
        .transactions-table td {
          padding: 10px;
        }
        .header {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }
        .header h1 {
          padding-left: 0;
        }
        .header h1::before {
          display: none;
        }
        .stats-cards {
          grid-template-columns: 1fr;
        }
      }

      /* æ­¦ç•¶æ´¾å‹•ç•«æ•ˆæœ */
      @keyframes taoPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
        100% {
          transform: scale(1);
        }
      }

      .stat-card {
        animation: taoPulse 4s infinite;
      }

      .stat-card:hover {
        animation: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- é é ­ -->
      <div class="header">
        <h1>ğŸ“Š æ¯æ—¥æ¶ˆè²»è¨˜éŒ„</h1>
        <div>
          <button class="back-btn" onclick="window.location.href='index.html'">
            â† è¿”å›ä¸»é 
          </button>
        </div>
      </div>

      <!-- æ§åˆ¶å€åŸŸ -->
      <div class="controls">
        <div class="date-selector">
          <label for="report-date">é¸æ“‡æ—¥æœŸï¼š</label>
          <input type="date" id="report-date" />
          <button onclick="dailyReport.loadDailyReport()">ğŸ” æŸ¥è©¢æ—¥æœŸ</button>
          <button onclick="dailyReport.loadYesterday()" class="btn-secondary">
            ğŸ“… æ˜¨æ—¥è¨˜éŒ„
          </button>
          <button onclick="dailyReport.loadToday()" class="btn-secondary">
            ğŸ“… ä»Šæ—¥è¨˜éŒ„
          </button>
        </div>

        <div class="month-selector">
          <label for="report-month">é¸æ“‡æœˆä»½ï¼š</label>
          <input type="month" id="report-month" />
          <button onclick="dailyReport.loadMonthlyReport()">ğŸ“Š æŸ¥è©¢æœˆä»½</button>
          <button
            onclick="dailyReport.loadCurrentMonth()"
            class="btn-secondary"
          >
            ğŸ“… æœ¬æœˆè¨˜éŒ„
          </button>
          <button onclick="dailyReport.loadLastMonth()" class="btn-secondary">
            ğŸ“… ä¸Šæœˆè¨˜éŒ„
          </button>
        </div>

        <div class="filter-buttons">
          <button
            onclick="dailyReport.filterTransactions('all')"
            class="btn-secondary active"
          >
            ğŸ“‹ å…¨éƒ¨
          </button>
          <button
            onclick="dailyReport.filterTransactions('income')"
            class="btn-secondary"
          >
            ğŸ’° æ”¶å…¥
          </button>
          <button
            onclick="dailyReport.filterTransactions('fixed_expense')"
            class="btn-secondary"
          >
            ğŸ  å›ºå®šé–‹æ”¯
          </button>
          <button
            onclick="dailyReport.filterTransactions('expense')"
            class="btn-secondary"
          >
            ğŸ’¸ å…¶ä»–é–‹æ”¯
          </button>
        </div>
      </div>

      <!-- çµ±è¨ˆå¡ç‰‡ -->
      <div class="stats-cards">
        <div class="stat-card income">
          <h3>ğŸ’° ç•¶æ—¥æ”¶å…¥</h3>
          <div class="amount" id="daily-income">$0.00</div>
        </div>
        <div class="stat-card fixed">
          <h3>ğŸ  å›ºå®šé–‹æ”¯</h3>
          <div class="amount" id="daily-fixed">$0.00</div>
        </div>
        <div class="stat-card expense">
          <h3>ğŸ’¸ å…¶ä»–é–‹æ”¯</h3>
          <div class="amount" id="daily-expense">$0.00</div>
        </div>
        <div class="stat-card spending-total">
          <h3>ğŸ“Š æ¶ˆè²»ç¸½é¡</h3>
          <div class="amount" id="daily-spending-total">$0.00</div>
          <div class="breakdown" style="font-size: 12px; margin-top: 5px">
            <span style="color: #ffc107"
              >å›ºå®š: <span id="fixed-percentage">0%</span></span
            >
            |
            <span style="color: #dc3545"
              >å…¶ä»–: <span id="expense-percentage">0%</span></span
            >
          </div>
        </div>
        <div class="stat-card total">
          <h3>âš–ï¸ ç•¶æ—¥çµé¤˜</h3>
          <div class="amount" id="daily-balance">$0.00</div>
        </div>
      </div>

      <!-- äº¤æ˜“è¨˜éŒ„è¡¨æ ¼ -->
      <div id="transactions-container">
        <table class="transactions-table">
          <thead>
            <tr>
              <th>æ™‚é–“</th>
              <th>é¡å‹</th>
              <th>åˆ†é¡</th>
              <th>æè¿°</th>
              <th>é‡‘é¡ (HKD)</th>
            </tr>
          </thead>
          <tbody id="transactions-body">
            <tr>
              <td colspan="5" class="empty-state">è«‹é¸æ“‡æ—¥æœŸæŸ¥çœ‹è¨˜éŒ„</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- åˆ†é æ§åˆ¶ -->
      <div
        style="text-align: center; margin-top: 20px; display: none"
        id="pagination"
      >
        <button onclick="dailyReport.previousDay()">â† å‰ä¸€å¤©</button>
        <span style="margin: 0 15px" id="current-date-display"></span>
        <button onclick="dailyReport.nextDay()">å¾Œä¸€å¤© â†’</button>
      </div>
    </div>

    <script>
      // ==================== æ¯æ—¥å ±å‘Šè·¯ç”±å®ˆè¡› ====================
      (function () {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser) {
          window.location.replace("login.html");
        }
      })();

      // ç›£è½è¿”å›éµ
      window.addEventListener("pageshow", function (event) {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser) {
          window.location.replace("login.html");
        }
      });

      class DailyReport {
        constructor() {
          this.currentDate = new Date();
          this.currentFilter = "all";
          this.init();
        }

        init() {
          // è¨­ç½®é»˜èªæ—¥æœŸç‚ºä»Šæ—¥
          this.setDateToInput(new Date());
          // åŠ è¼‰ä»Šæ—¥è¨˜éŒ„
          this.loadToday();

          // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
          this.checkLogin();
        }

        checkLogin() {
          const currentUser = JSON.parse(localStorage.getItem("currentUser"));
          if (!currentUser) {
            alert("è«‹å…ˆç™»å…¥ç³»çµ±ï¼");
            window.location.href = "login.html";
            return false;
          }
          return true;
        }

        setDateToInput(date) {
          const formattedDate = date.toISOString().split("T")[0];
          document.getElementById("report-date").value = formattedDate;
          this.currentDate = date;
        }

        // åŠ è¼‰æŒ‡å®šæ—¥æœŸçš„è¨˜éŒ„
        loadDailyReport() {
          const dateInput = document.getElementById("report-date").value;
          if (!dateInput) {
            alert("è«‹é¸æ“‡æ—¥æœŸ");
            return;
          }

          const selectedDate = new Date(dateInput);
          this.displayDailyReport(selectedDate);
        }

        // åŠ è¼‰æ˜¨æ—¥è¨˜éŒ„
        loadYesterday() {
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          this.setDateToInput(yesterday);
          this.displayDailyReport(yesterday);
        }

        // åŠ è¼‰ä»Šæ—¥è¨˜éŒ„
        loadToday() {
          const today = new Date();
          this.setDateToInput(today);
          this.displayDailyReport(today);
        }

        // é¡¯ç¤ºæ¯æ—¥å ±å‘Š
        displayDailyReport(date) {
          const formattedDate = date.toISOString().split("T")[0];
          const username =
            JSON.parse(localStorage.getItem("currentUser"))?.username ||
            "default";

          let dailyTransactions = [];
          let dailySummary = null;

          // é¦–å…ˆæª¢æŸ¥æ˜¯å¦æœ‰æ­¸æª”æ•¸æ“š
          const archiveKey = `daily-archive-${username}-${formattedDate}`;
          const archivedData = localStorage.getItem(archiveKey);

          if (archivedData) {
            // ä½¿ç”¨æ­¸æª”æ•¸æ“š
            const archive = JSON.parse(archivedData);
            dailyTransactions = archive.transactions;
            dailySummary = archive.summary;
            console.log(`ğŸ“ è¼‰å…¥æ­¸æª”æ•¸æ“š: ${formattedDate}`);
          } else {
            // å¾ç•¶å‰æœˆä»½æ•¸æ“šä¸­æŸ¥æ‰¾
            let allTransactions = [];
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key.startsWith(`transactions-${username}-`)) {
                const transactions =
                  JSON.parse(localStorage.getItem(key)) || [];
                allTransactions = allTransactions.concat(transactions);
              }
            }
            dailyTransactions = allTransactions.filter(
              (t) => t.date === formattedDate
            );
            console.log(`ğŸ” å¾ç•¶å‰æ•¸æ“šæŸ¥æ‰¾: ${formattedDate}`);
          }

          // æ‡‰ç”¨ç¯©é¸
          if (this.currentFilter !== "all") {
            dailyTransactions = dailyTransactions.filter(
              (t) => t.type === this.currentFilter
            );
          }

          // æ›´æ–°çµ±è¨ˆä¿¡æ¯
          this.updateStats(dailyTransactions, dailySummary);

          // æ›´æ–°è¡¨æ ¼
          this.updateTable(dailyTransactions, formattedDate);

          // æ›´æ–°åˆ†é é¡¯ç¤º
          this.updatePagination(date);

          // é¡¯ç¤ºæ•¸æ“šä¾†æºæç¤º
          this.showDataSource(!!archivedData, formattedDate);
        }

        // æ›´æ–°çµ±è¨ˆä¿¡æ¯
        updateStats(transactions, summary = null) {
          let totalIncome, totalFixed, totalExpense, totalSpending, balance;

          if (summary) {
            // ä½¿ç”¨æ­¸æª”çš„çµ±è¨ˆæ•¸æ“š
            totalIncome = summary.totalIncome;
            totalFixed = summary.totalFixed;
            totalExpense = summary.totalExpense;
            totalSpending = summary.totalSpending;
            balance = summary.balance;
          } else {
            // å¯¦æ™‚è¨ˆç®—çµ±è¨ˆæ•¸æ“š
            totalIncome = transactions
              .filter((t) => t.type === "income")
              .reduce((sum, t) => sum + t.amount, 0);

            totalFixed = transactions
              .filter((t) => t.type === "fixed_expense")
              .reduce((sum, t) => sum + t.amount, 0);

            totalExpense = transactions
              .filter((t) => t.type === "expense")
              .reduce((sum, t) => sum + t.amount, 0);

            totalSpending = totalFixed + totalExpense;
            balance = totalIncome - totalSpending;
          }

          // è¨ˆç®—ç™¾åˆ†æ¯”
          let fixedPercentage = 0;
          let expensePercentage = 0;

          if (totalSpending > 0) {
            fixedPercentage = Math.round((totalFixed / totalSpending) * 100);
            expensePercentage = Math.round(
              (totalExpense / totalSpending) * 100
            );
          }

          // æ›´æ–°é¡¯ç¤º
          document.getElementById(
            "daily-income"
          ).textContent = `$${totalIncome.toFixed(2)}`;
          document.getElementById(
            "daily-fixed"
          ).textContent = `$${totalFixed.toFixed(2)}`;
          document.getElementById(
            "daily-expense"
          ).textContent = `$${totalExpense.toFixed(2)}`;
          document.getElementById(
            "daily-spending-total"
          ).textContent = `$${totalSpending.toFixed(2)}`;
          document.getElementById(
            "daily-balance"
          ).textContent = `$${balance.toFixed(2)}`;

          // æ›´æ–°ç™¾åˆ†æ¯”
          document.getElementById(
            "fixed-percentage"
          ).textContent = `${fixedPercentage}%`;
          document.getElementById(
            "expense-percentage"
          ).textContent = `${expensePercentage}%`;

          // æ ¹æ“šçµé¤˜è¨­ç½®é¡è‰²
          const balanceElement = document.getElementById("daily-balance");
          if (balance > 0) {
            balanceElement.style.color = "#28a745";
          } else if (balance < 0) {
            balanceElement.style.color = "#dc3545";
          } else {
            balanceElement.style.color = "#666";
          }

          // æ¶ˆè²»ç¸½é¡å¡ç‰‡å˜…é¡è‰²è¨­ç½®
          const spendingElement = document.getElementById(
            "daily-spending-total"
          );
          if (totalSpending > 0) {
            spendingElement.style.color = "#6f42c1";
          } else {
            spendingElement.style.color = "#666";
          }
        }

        // æ›´æ–°è¡¨æ ¼
        updateTable(transactions, date) {
          const tbody = document.getElementById("transactions-body");

          if (transactions.length === 0) {
            tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="empty-state">
                                ğŸ“ ${date} æ²’æœ‰äº¤æ˜“è¨˜éŒ„
                            </td>
                        </tr>
                    `;
            return;
          }

          // æŒ‰æ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
          transactions.sort((a, b) => {
            // å¦‚æœæœ‰æ™‚é–“ä¿¡æ¯å°±æŒ‰æ™‚é–“æ’åºï¼Œå¦å‰‡æŒ‰IDæ’åº
            if (a.timestamp && b.timestamp) {
              return new Date(b.timestamp) - new Date(a.timestamp);
            }
            return b.id - a.id;
          });

          tbody.innerHTML = transactions
            .map((transaction) => {
              const typeText =
                {
                  income: "ğŸ’° æ”¶å…¥",
                  fixed_expense: "ğŸ  å›ºå®šé–‹æ”¯",
                  expense: "ğŸ’¸ å…¶ä»–é–‹æ”¯",
                }[transaction.type] || transaction.type;

              const typeClass =
                {
                  income: "type-income",
                  fixed_expense: "type-fixed",
                  expense: "type-expense",
                }[transaction.type] || "";

              // æ ¼å¼åŒ–æ™‚é–“é¡¯ç¤ºï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
              let timeDisplay = transaction.date;
              if (transaction.timestamp) {
                const time = new Date(transaction.timestamp).toLocaleTimeString(
                  "zh-HK"
                );
                timeDisplay = `${transaction.date} ${time}`;
              }

              return `
                        <tr>
                            <td>${timeDisplay}</td>
                            <td><span class="type-badge ${typeClass}">${typeText}</span></td>
                            <td>${transaction.category}</td>
                            <td>${transaction.description}</td>
                            <td style="font-weight: bold; color: ${
                              transaction.type === "income"
                                ? "#28a745"
                                : "#dc3545"
                            }">
                                ${
                                  transaction.type === "income" ? "+" : "-"
                                }$${transaction.amount.toFixed(2)}
                            </td>
                        </tr>
                    `;
            })
            .join("");
        }

        // æ›´æ–°åˆ†é æ§åˆ¶
        updatePagination(date) {
          const pagination = document.getElementById("pagination");
          const display = document.getElementById("current-date-display");

          const today = new Date();
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);

          // å¦‚æœé¸æ“‡çš„æ—¥æœŸä¸æ˜¯ä»Šå¤©ï¼Œé¡¯ç¤ºåˆ†é æ§åˆ¶
          if (date.toDateString() !== today.toDateString()) {
            pagination.style.display = "block";
            display.textContent = date.toLocaleDateString("zh-HK", {
              year: "numeric",
              month: "long",
              day: "numeric",
              weekday: "long",
            });
          } else {
            pagination.style.display = "none";
          }
        }

        // å‰ä¸€å¤©
        previousDay() {
          const newDate = new Date(this.currentDate);
          newDate.setDate(newDate.getDate() - 1);
          this.setDateToInput(newDate);
          this.displayDailyReport(newDate);
        }

        // å¾Œä¸€å¤©
        nextDay() {
          const newDate = new Date(this.currentDate);
          newDate.setDate(newDate.getDate() + 1);

          // ä¸èƒ½é¸æ“‡æœªä¾†çš„æ—¥æœŸ
          const today = new Date();
          if (newDate <= today) {
            this.setDateToInput(newDate);
            this.displayDailyReport(newDate);
          } else {
            alert("ä¸èƒ½æŸ¥çœ‹æœªä¾†çš„è¨˜éŒ„");
          }
        }

        // é¡¯ç¤ºæ•¸æ“šä¾†æºæç¤º
        showDataSource(isArchived, date) {
          // ç§»é™¤ç¾æœ‰æç¤º
          const existingHint = document.getElementById("data-source-hint");
          if (existingHint) {
            existingHint.remove();
          }

          const hint = document.createElement("div");
          hint.id = "data-source-hint";
          hint.style.cssText = `
                    text-align: center;
                    margin: 10px 0;
                    padding: 8px;
                    border-radius: 5px;
                    font-size: 14px;
                    background: ${isArchived ? "#d4edda" : "#fff3cd"};
                    color: ${isArchived ? "#155724" : "#856404"};
                    border: 1px solid ${isArchived ? "#c3e6cb" : "#ffeaa7"};
                `;

          if (isArchived) {
            hint.innerHTML = `ğŸ“ é¡¯ç¤ºæ­¸æª”æ•¸æ“š (${date}) - æ­¤æ—¥æœŸå·²å®Œæˆæ—¥çµ`;
          } else {
            hint.innerHTML = `ğŸ” é¡¯ç¤ºç•¶å‰æ•¸æ“š (${date}) - æ­¤æ—¥æœŸå°šæœªæ—¥çµ`;
          }

          // æ’å…¥åˆ°æ§åˆ¶å€åŸŸå¾Œé¢
          const controls = document.querySelector(".controls");
          controls.parentNode.insertBefore(hint, controls.nextSibling);
        }

        // ç¯©é¸äº¤æ˜“è¨˜éŒ„
        filterTransactions(filterType) {
          this.currentFilter = filterType;

          // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
          document.querySelectorAll(".filter-buttons button").forEach((btn) => {
            btn.classList.remove("active");
          });
          event.target.classList.add("active");

          // é‡æ–°é¡¯ç¤ºç•¶å‰æ—¥æœŸå˜…è¨˜éŒ„ï¼ˆæœƒè‡ªå‹•æ‡‰ç”¨ç¯©é¸ï¼‰
          this.displayDailyReport(this.currentDate);
        }

        // åŠ è¼‰æœˆä»½å ±å‘Š
        loadMonthlyReport() {
          const monthInput = document.getElementById("report-month").value;
          if (!monthInput) {
            alert("è«‹é¸æ“‡æœˆä»½");
            return;
          }

          this.displayMonthlyReport(monthInput);
        }

        // åŠ è¼‰æœ¬æœˆè¨˜éŒ„
        loadCurrentMonth() {
          const now = new Date();
          const currentMonth = `${now.getFullYear()}-${String(
            now.getMonth() + 1
          ).padStart(2, "0")}`;
          document.getElementById("report-month").value = currentMonth;
          this.displayMonthlyReport(currentMonth);
        }

        // åŠ è¼‰ä¸Šæœˆè¨˜éŒ„
        loadLastMonth() {
          const now = new Date();
          now.setMonth(now.getMonth() - 1);
          const lastMonth = `${now.getFullYear()}-${String(
            now.getMonth() + 1
          ).padStart(2, "0")}`;
          document.getElementById("report-month").value = lastMonth;
          this.displayMonthlyReport(lastMonth);
        }

        // é¡¯ç¤ºæœˆä»½å ±å‘Š
        displayMonthlyReport(month) {
          const username =
            JSON.parse(localStorage.getItem("currentUser"))?.username ||
            "default";

          // ç²å–æ‰€æœ‰äº¤æ˜“è¨˜éŒ„
          let allTransactions = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(`transactions-${username}-`)) {
              const transactions = JSON.parse(localStorage.getItem(key)) || [];
              allTransactions = allTransactions.concat(transactions);
            }
          }

          // éæ¿¾æŒ‡å®šæœˆä»½çš„è¨˜éŒ„
          const monthlyTransactions = allTransactions.filter((t) =>
            t.date.startsWith(month)
          );

          // æŒ‰æ—¥æœŸåˆ†çµ„
          const transactionsByDate = {};
          monthlyTransactions.forEach((transaction) => {
            if (!transactionsByDate[transaction.date]) {
              transactionsByDate[transaction.date] = [];
            }
            transactionsByDate[transaction.date].push(transaction);
          });

          // æ›´æ–°æœˆä»½çµ±è¨ˆä¿¡æ¯
          this.updateMonthlyStats(monthlyTransactions, month);

          // æ›´æ–°æœˆä»½è¡¨æ ¼
          this.updateMonthlyTable(transactionsByDate, month);

          // éš±è—åˆ†é æ§åˆ¶
          document.getElementById("pagination").style.display = "none";

          // é¡¯ç¤ºæ•¸æ“šä¾†æºæç¤º
          this.showDataSource(false, `${month} æœˆä»½`);
        }

        // æ›´æ–°æœˆä»½çµ±è¨ˆä¿¡æ¯
        updateMonthlyStats(transactions, month) {
          const totalIncome = transactions
            .filter((t) => t.type === "income")
            .reduce((sum, t) => sum + t.amount, 0);

          const totalFixed = transactions
            .filter((t) => t.type === "fixed_expense")
            .reduce((sum, t) => sum + t.amount, 0);

          const totalExpense = transactions
            .filter((t) => t.type === "expense")
            .reduce((sum, t) => sum + t.amount, 0);

          const totalSpending = totalFixed + totalExpense;
          const balance = totalIncome - totalSpending;

          // è¨ˆç®—æ¯æ—¥å¹³å‡
          const uniqueDates = [...new Set(transactions.map((t) => t.date))];
          const daysCount = uniqueDates.length;

          const avgIncome = daysCount > 0 ? totalIncome / daysCount : 0;
          const avgSpending = daysCount > 0 ? totalSpending / daysCount : 0;

          // è¨ˆç®—ç™¾åˆ†æ¯”
          let fixedPercentage = 0;
          let expensePercentage = 0;

          if (totalSpending > 0) {
            fixedPercentage = Math.round((totalFixed / totalSpending) * 100);
            expensePercentage = Math.round(
              (totalExpense / totalSpending) * 100
            );
          }

          // æ›´æ–°é¡¯ç¤º
          document.getElementById(
            "daily-income"
          ).textContent = `$${totalIncome.toFixed(2)}`;
          document.getElementById(
            "daily-fixed"
          ).textContent = `$${totalFixed.toFixed(2)}`;
          document.getElementById(
            "daily-expense"
          ).textContent = `$${totalExpense.toFixed(2)}`;
          document.getElementById(
            "daily-spending-total"
          ).textContent = `$${totalSpending.toFixed(2)}`;
          document.getElementById(
            "daily-balance"
          ).textContent = `$${balance.toFixed(2)}`;

          // æ›´æ–°ç™¾åˆ†æ¯”
          document.getElementById(
            "fixed-percentage"
          ).textContent = `${fixedPercentage}%`;
          document.getElementById(
            "expense-percentage"
          ).textContent = `${expensePercentage}%`;

          // æ·»åŠ æœˆä»½çµ±è¨ˆä¿¡æ¯
          const existingMonthStats = document.getElementById("monthly-stats");
          if (existingMonthStats) {
            existingMonthStats.remove();
          }

          const monthStats = document.createElement("div");
          monthStats.id = "monthly-stats";
          monthStats.style.cssText = `
                    background: #e8f4fd;
                    padding: 15px;
                    border-radius: 8px;
                    margin: 15px 0;
                    border-left: 4px solid #2196F3;
                `;
          monthStats.innerHTML = `
                    <h3 style="margin: 0 0 10px 0; color: #1976D2;">ğŸ“ˆ ${month} æœˆä»½çµ±è¨ˆ</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div>
                            <strong>äº¤æ˜“å¤©æ•¸:</strong> ${daysCount} å¤©
                        </div>
                        <div>
                            <strong>ç¸½äº¤æ˜“æ•¸:</strong> ${transactions.length} ç­†
                        </div>
                        <div>
                            <strong>æ—¥å‡æ”¶å…¥:</strong> $${avgIncome.toFixed(2)}
                        </div>
                        <div>
                            <strong>æ—¥å‡æ”¯å‡º:</strong> $${avgSpending.toFixed(
                              2
                            )}
                        </div>
                    </div>
                `;

          // æ’å…¥åˆ°çµ±è¨ˆå¡ç‰‡å¾Œé¢
          const statsCards = document.querySelector(".stats-cards");
          statsCards.parentNode.insertBefore(
            monthStats,
            statsCards.nextSibling
          );
        }

        // æ›´æ–°æœˆä»½è¡¨æ ¼
        updateMonthlyTable(transactionsByDate, month) {
          const tbody = document.getElementById("transactions-body");

          const dates = Object.keys(transactionsByDate).sort().reverse(); // æ—¥æœŸå€’åºæ’åˆ—

          if (dates.length === 0) {
            tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="empty-state">
                                ğŸ“ ${month} æœˆä»½æ²’æœ‰äº¤æ˜“è¨˜éŒ„
                            </td>
                        </tr>
                    `;
            return;
          }

          let tableHTML = "";

          dates.forEach((date) => {
            const dayTransactions = transactionsByDate[date];
            const dayIncome = dayTransactions
              .filter((t) => t.type === "income")
              .reduce((sum, t) => sum + t.amount, 0);
            const dayFixed = dayTransactions
              .filter((t) => t.type === "fixed_expense")
              .reduce((sum, t) => sum + t.amount, 0);
            const dayExpense = dayTransactions
              .filter((t) => t.type === "expense")
              .reduce((sum, t) => sum + t.amount, 0);
            const dayTotal = dayFixed + dayExpense;
            const dayBalance = dayIncome - dayTotal;

            // æ—¥æœŸæ¨™é¡Œè¡Œ
            tableHTML += `
                        <tr style="background: #f1f8ff;">
                            <td colspan="5" style="font-weight: bold; padding: 12px;">
                                ğŸ“… ${date} 
                                <span style="float: right; font-size: 14px; font-weight: normal;">
                                    æ”¶å…¥: <span style="color: #28a745;">$${dayIncome.toFixed(
                                      2
                                    )}</span> | 
                                    æ”¯å‡º: <span style="color: #dc3545;">$${dayTotal.toFixed(
                                      2
                                    )}</span> | 
                                    çµé¤˜: <span style="color: ${
                                      dayBalance >= 0 ? "#28a745" : "#dc3545"
                                    }">$${dayBalance.toFixed(2)}</span>
                                </span>
                            </td>
                        </tr>
                    `;

            // è©²æ—¥æœŸå˜…äº¤æ˜“è¨˜éŒ„
            dayTransactions.forEach((transaction) => {
              const typeText =
                {
                  income: "ğŸ’° æ”¶å…¥",
                  fixed_expense: "ğŸ  å›ºå®šé–‹æ”¯",
                  expense: "ğŸ’¸ å…¶ä»–é–‹æ”¯",
                }[transaction.type] || transaction.type;

              const typeClass =
                {
                  income: "type-income",
                  fixed_expense: "type-fixed",
                  expense: "type-expense",
                }[transaction.type] || "";

              let timeDisplay = transaction.date;
              if (transaction.timestamp) {
                const time = new Date(transaction.timestamp).toLocaleTimeString(
                  "zh-HK"
                );
                timeDisplay = `${transaction.date} ${time}`;
              }

              tableHTML += `
                            <tr>
                                <td>${timeDisplay}</td>
                                <td><span class="type-badge ${typeClass}">${typeText}</span></td>
                                <td>${transaction.category}</td>
                                <td>${transaction.description}</td>
                                <td style="font-weight: bold; color: ${
                                  transaction.type === "income"
                                    ? "#28a745"
                                    : "#dc3545"
                                }">
                                    ${
                                      transaction.type === "income" ? "+" : "-"
                                    }$${transaction.amount.toFixed(2)}
                                </td>
                            </tr>
                        `;
            });

            // æ·»åŠ ç©ºè¡Œåˆ†éš”
            tableHTML += `<tr style="height: 10px;"><td colspan="5"></td></tr>`;
          });

          tbody.innerHTML = tableHTML;
        }
      }

      // åˆå§‹åŒ–æ¯æ—¥å ±å‘Š
      const dailyReport = new DailyReport();
    </script>
  </body>
</html>
