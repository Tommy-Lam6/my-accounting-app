<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ÊØèÊó•Ê∂àË≤ªË®òÈåÑ - Êô∫ËÉΩË®òË≥¨Á≥ªÁµ±</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "DFKai-SB", "Ê®ôÊ•∑È´î", "Microsoft JhengHei", sans-serif;
        background: linear-gradient(135deg, #e8f4e8 0%, #c3e6c3 100%);
        padding: 20px;
        color: #2d5016;
        letter-spacing: 0.5px;
        line-height: 1.6;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e8 100%);
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(45, 80, 22, 0.2);
        border: 3px solid #8a6d3b;
        position: relative;
        overflow: hidden;
      }
      .container::before {
        content: "‚òØ";
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 28px;
        color: #8a6d3b;
        opacity: 0.3;
        transform: rotate(15deg);
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 3px solid #8a6d3b;
        position: relative;
      }
      .header::after {
        content: "";
        position: absolute;
        bottom: -3px;
        left: 0;
        width: 100px;
        height: 3px;
        background: linear-gradient(90deg, #2d5016, #8a6d3b);
        border-radius: 2px;
      }
      .header h1 {
        color: #2d5016;
        font-size: 32px;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
        padding-left: 40px;
      }
      .header h1::before {
        content: "ÈÅì";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        font-size: 36px;
        color: #8a6d3b;
        opacity: 0.8;
      }
      .controls {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 25px;
        background: rgba(255, 255, 255, 0.7);
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #8a6d3b;
      }
      .date-selector,
      .month-selector {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }
      .date-selector input,
      .month-selector input {
        padding: 10px 15px;
        border: 2px solid #8a6d3b;
        border-radius: 8px;
        font-size: 16px;
        font-family: "DFKai-SB", "Ê®ôÊ•∑È´î", "Microsoft JhengHei", sans-serif;
        background: #f9f9f9;
        transition: all 0.3s ease;
      }
      .date-selector input:focus,
      .month-selector input:focus {
        outline: none;
        border-color: #2d5016;
        background: white;
        box-shadow: 0 0 8px rgba(45, 80, 22, 0.2);
      }
      button {
        padding: 12px 20px;
        background: linear-gradient(135deg, #2d5016 0%, #4a7c3a 100%);
        color: #f1f8e9;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-family: "DFKai-SB", "Ê®ôÊ•∑È´î", "Microsoft JhengHei", sans-serif;
        font-weight: 600;
        box-shadow: 0 4px 8px rgba(45, 80, 22, 0.3);
        border: 1px solid #8a6d3b;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      button:hover {
        background: linear-gradient(135deg, #4a7c3a 0%, #2d5016 100%);
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(45, 80, 22, 0.4);
      }
      .btn-secondary {
        background: linear-gradient(135deg, #8a6d3b 0%, #a9925d 100%);
      }
      .btn-secondary:hover {
        background: linear-gradient(135deg, #a9925d 0%, #8a6d3b 100%);
      }

      .filter-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .filter-buttons button.active {
        background: linear-gradient(135deg, #2d5016 0%, #8a6d3b 100%);
        border: 2px solid #f1f8e9;
        transform: scale(1.05);
      }

      /* Áµ±Ë®àÂç°Áâá */
      .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
      }
      .stat-card {
        background: linear-gradient(135deg, #f8fdf8 0%, #f0f9f0 100%);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        border-left: 6px solid;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-top: 1px solid #8a6d3b;
        border-right: 1px solid #8a6d3b;
        border-bottom: 1px solid #8a6d3b;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #2d5016, #8a6d3b);
      }
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      }
      .stat-card.income {
        border-left-color: #2d5016;
      }
      .stat-card.fixed {
        border-left-color: #8a6d3b;
      }
      .stat-card.expense {
        border-left-color: #8b4513;
      }
      .stat-card.spending-total {
        border-left-color: #1565c0;
      }
      .stat-card.total {
        border-left-color: #2d5016;
      }
      .stat-card h3 {
        font-size: 16px;
        color: #5d4037;
        margin-bottom: 10px;
        font-weight: 600;
      }
      .stat-card .amount {
        font-size: 24px;
        font-weight: bold;
        color: #2d5016;
      }

      /* Ë°®Ê†ºÊ®£Âºè */
      .transactions-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 25px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border: 2px solid #8a6d3b;
      }
      .transactions-table th,
      .transactions-table td {
        border: 1px solid #8a6d3b;
        padding: 15px;
        text-align: left;
        font-size: 16px;
      }
      .transactions-table th {
        background: linear-gradient(135deg, #2d5016 0%, #4a7c3a 100%);
        color: #f1f8e9;
        font-weight: 600;
        font-size: 18px;
        text-align: center;
      }
      .transactions-table tr:nth-child(even) {
        background: rgba(241, 248, 233, 0.5);
      }
      .transactions-table tr:hover {
        background: rgba(232, 245, 232, 0.8);
        transform: scale(1.01);
        transition: all 0.2s ease;
      }
      .type-badge {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: bold;
        font-family: "DFKai-SB", "Ê®ôÊ•∑È´î", "Microsoft JhengHei", sans-serif;
      }
      .type-income {
        background: linear-gradient(135deg, #d4efdf, #27ae60);
        color: #196f3d;
        border: 1px solid #27ae60;
      }
      .type-fixed {
        background: linear-gradient(135deg, #fdebd0, #e67e22);
        color: #a84300;
        border: 1px solid #e67e22;
      }
      .type-expense {
        background: linear-gradient(135deg, #fadbd8, #e74c3c);
        color: #922b21;
        border: 1px solid #e74c3c;
      }

      .empty-state {
        text-align: center;
        padding: 50px;
        color: #8a6d3b;
        font-size: 18px;
        font-style: italic;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 12px;
        border: 2px dashed #8a6d3b;
      }
      .back-btn {
        background: linear-gradient(135deg, #8a6d3b 0%, #a9925d 100%);
        margin-right: 15px;
      }

      /* Ê≠¶Áï∂Ê¥æÁâπËâ≤ÂÖÉÁ¥† */
      .taoist-divider {
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #2d5016, #8a6d3b, #2d5016);
        border-radius: 2px;
        margin: 20px 0;
        position: relative;
        overflow: hidden;
      }

      .taoist-divider::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.4),
          transparent
        );
        animation: balanceFlow 3s infinite;
      }

      @keyframes balanceFlow {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      @media (max-width: 768px) {
        .controls {
          flex-direction: column;
          align-items: stretch;
        }
        .date-selector,
        .month-selector {
          justify-content: space-between;
        }
        .transactions-table {
          font-size: 14px;
        }
        .transactions-table th,
        .transactions-table td {
          padding: 10px;
        }
        .header {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }
        .header h1 {
          padding-left: 0;
        }
        .header h1::before {
          display: none;
        }
        .stats-cards {
          grid-template-columns: 1fr;
        }
      }

      /* Ê≠¶Áï∂Ê¥æÂãïÁï´ÊïàÊûú */
      @keyframes taoPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
        100% {
          transform: scale(1);
        }
      }

      .stat-card {
        animation: taoPulse 4s infinite;
      }

      .stat-card:hover {
        animation: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- È†ÅÈ†≠ -->
      <div class="header">
        <h1>üìä ÊØèÊó•Ê∂àË≤ªË®òÈåÑ</h1>
        <div>
          <button class="back-btn" onclick="window.location.href='index.html'">
            ‚Üê ËøîÂõû‰∏ªÈ†Å
          </button>
        </div>
      </div>

      <!-- ÊéßÂà∂ÂçÄÂüü -->
      <div class="controls">
        <div class="date-selector">
          <label for="report-date">ÈÅ∏ÊìáÊó•ÊúüÔºö</label>
          <input type="date" id="report-date" />
          <button onclick="dailyReport.loadDailyReport()">üîç Êü•Ë©¢Êó•Êúü</button>
          <button onclick="dailyReport.loadYesterday()" class="btn-secondary">
            üìÖ Êò®Êó•Ë®òÈåÑ
          </button>
          <button onclick="dailyReport.loadToday()" class="btn-secondary">
            üìÖ ‰ªäÊó•Ë®òÈåÑ
          </button>
        </div>

        <div class="month-selector">
          <label for="report-month">ÈÅ∏ÊìáÊúà‰ªΩÔºö</label>
          <input type="month" id="report-month" />
          <button onclick="dailyReport.loadMonthlyReport()">üìä Êü•Ë©¢Êúà‰ªΩ</button>
          <button
            onclick="dailyReport.loadCurrentMonth()"
            class="btn-secondary"
          >
            üìÖ Êú¨ÊúàË®òÈåÑ
          </button>
          <button onclick="dailyReport.loadLastMonth()" class="btn-secondary">
            üìÖ ‰∏äÊúàË®òÈåÑ
          </button>
        </div>

        <div class="filter-buttons">
          <button
            onclick="dailyReport.filterTransactions('all')"
            class="btn-secondary active"
          >
            üìã ÂÖ®ÈÉ®
          </button>
          <button
            onclick="dailyReport.filterTransactions('income')"
            class="btn-secondary"
          >
            üí∞ Êî∂ÂÖ•
          </button>
          <button
            onclick="dailyReport.filterTransactions('fixed_expense')"
            class="btn-secondary"
          >
            üè† Âõ∫ÂÆöÈñãÊîØ
          </button>
          <button
            onclick="dailyReport.filterTransactions('expense')"
            class="btn-secondary"
          >
            üí∏ ÂÖ∂‰ªñÈñãÊîØ
          </button>
        </div>
      </div>

      <!-- Áµ±Ë®àÂç°Áâá -->
      <div class="stats-cards">
        <div class="stat-card income">
          <h3>üí∞ Áï∂Êó•Êî∂ÂÖ•</h3>
          <div class="amount" id="daily-income">$0.00</div>
        </div>
        <div class="stat-card fixed">
          <h3>üè† Âõ∫ÂÆöÈñãÊîØ</h3>
          <div class="amount" id="daily-fixed">$0.00</div>
        </div>
        <div class="stat-card expense">
          <h3>üí∏ ÂÖ∂‰ªñÈñãÊîØ</h3>
          <div class="amount" id="daily-expense">$0.00</div>
        </div>
        <div class="stat-card spending-total">
          <h3>üìä Ê∂àË≤ªÁ∏ΩÈ°ç</h3>
          <div class="amount" id="daily-spending-total">$0.00</div>
          <div class="breakdown" style="font-size: 12px; margin-top: 5px">
            <span style="color: #ffc107"
              >Âõ∫ÂÆö: <span id="fixed-percentage">0%</span></span
            >
            |
            <span style="color: #dc3545"
              >ÂÖ∂‰ªñ: <span id="expense-percentage">0%</span></span
            >
          </div>
        </div>
        <div class="stat-card total">
          <h3>‚öñÔ∏è Áï∂Êó•ÁµêÈ§ò</h3>
          <div class="amount" id="daily-balance">$0.00</div>
        </div>
      </div>

      <!-- ‰∫§ÊòìË®òÈåÑË°®Ê†º -->
      <div id="transactions-container">
        <table class="transactions-table">
          <thead>
            <tr>
              <th>ÊôÇÈñì</th>
              <th>È°ûÂûã</th>
              <th>ÂàÜÈ°û</th>
              <th>ÊèèËø∞</th>
              <th>ÈáëÈ°ç (HKD)</th>
            </tr>
          </thead>
          <tbody id="transactions-body">
            <tr>
              <td colspan="5" class="empty-state">Ë´ãÈÅ∏ÊìáÊó•ÊúüÊü•ÁúãË®òÈåÑ</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- ÂàÜÈ†ÅÊéßÂà∂ -->
      <div
        style="text-align: center; margin-top: 20px; display: none"
        id="pagination"
      >
        <button onclick="dailyReport.previousDay()">‚Üê Ââç‰∏ÄÂ§©</button>
        <span style="margin: 0 15px" id="current-date-display"></span>
        <button onclick="dailyReport.nextDay()">Âæå‰∏ÄÂ§© ‚Üí</button>
      </div>
    </div>

    <script>
      // ==================== ÊØèÊó•Â†±ÂëäË∑ØÁî±ÂÆàË°õ ====================
      (function () {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser) {
          window.location.replace("login.html");
        }
      })();

      // Áõ£ËÅΩËøîÂõûÈçµ
      window.addEventListener("pageshow", function (event) {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser) {
          window.location.replace("login.html");
        }
      });

      class DailyReport {
        constructor() {
          this.currentDate = new Date();
          this.currentFilter = "all";
          this.init();
        }

        init() {
          // Ë®≠ÁΩÆÈªòË™çÊó•ÊúüÁÇ∫‰ªäÊó•
          this.setDateToInput(new Date());
          // Âä†Ëºâ‰ªäÊó•Ë®òÈåÑ
          this.loadToday();

          // Ê™¢Êü•ÁôªÂÖ•ÁãÄÊÖã
          this.checkLogin();
        }

        checkLogin() {
          const currentUser = JSON.parse(localStorage.getItem("currentUser"));
          if (!currentUser) {
            alert("Ë´ãÂÖàÁôªÂÖ•Á≥ªÁµ±ÔºÅ");
            window.location.href = "login.html";
            return false;
          }
          return true;
        }

        setDateToInput(date) {
          const formattedDate = date.toISOString().split("T")[0];
          document.getElementById("report-date").value = formattedDate;
          this.currentDate = date;
        }

        // Âä†ËºâÊåáÂÆöÊó•ÊúüÁöÑË®òÈåÑ
        loadDailyReport() {
          const dateInput = document.getElementById("report-date").value;
          if (!dateInput) {
            alert("Ë´ãÈÅ∏ÊìáÊó•Êúü");
            return;
          }

          const selectedDate = new Date(dateInput);
          this.displayDailyReport(selectedDate);
        }

        // Âä†ËºâÊò®Êó•Ë®òÈåÑ
        loadYesterday() {
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          this.setDateToInput(yesterday);
          this.displayDailyReport(yesterday);
        }

        // Âä†Ëºâ‰ªäÊó•Ë®òÈåÑ
        loadToday() {
          const today = new Date();
          this.setDateToInput(today);
          this.displayDailyReport(today);
        }

        // È°ØÁ§∫ÊØèÊó•Â†±Âëä
        displayDailyReport(date) {
          const formattedDate = date.toISOString().split("T")[0];
          const username =
            JSON.parse(localStorage.getItem("currentUser"))?.username ||
            "default";

          let dailyTransactions = [];
          let dailySummary = null;

          // È¶ñÂÖàÊ™¢Êü•ÊòØÂê¶ÊúâÊ≠∏Ê™îÊï∏Êìö
          const archiveKey = `daily-archive-${username}-${formattedDate}`;
          const archivedData = localStorage.getItem(archiveKey);

          if (archivedData) {
            // ‰ΩøÁî®Ê≠∏Ê™îÊï∏Êìö
            const archive = JSON.parse(archivedData);
            dailyTransactions = archive.transactions;
            dailySummary = archive.summary;
            console.log(`üìÅ ËºâÂÖ•Ê≠∏Ê™îÊï∏Êìö: ${formattedDate}`);
          } else {
            // ÂæûÁï∂ÂâçÊúà‰ªΩÊï∏Êìö‰∏≠Êü•Êâæ
            let allTransactions = [];
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key.startsWith(`transactions-${username}-`)) {
                const transactions =
                  JSON.parse(localStorage.getItem(key)) || [];
                allTransactions = allTransactions.concat(transactions);
              }
            }
            dailyTransactions = allTransactions.filter(
              (t) => t.date === formattedDate
            );
            console.log(`üîç ÂæûÁï∂ÂâçÊï∏ÊìöÊü•Êâæ: ${formattedDate}`);
          }

          // ÊáâÁî®ÁØ©ÈÅ∏
          if (this.currentFilter !== "all") {
            dailyTransactions = dailyTransactions.filter(
              (t) => t.type === this.currentFilter
            );
          }

          // Êõ¥Êñ∞Áµ±Ë®à‰ø°ÊÅØ
          this.updateStats(dailyTransactions, dailySummary);

          // Êõ¥Êñ∞Ë°®Ê†º
          this.updateTable(dailyTransactions, formattedDate);

          // Êõ¥Êñ∞ÂàÜÈ†ÅÈ°ØÁ§∫
          this.updatePagination(date);

          // È°ØÁ§∫Êï∏Êìö‰æÜÊ∫êÊèêÁ§∫
          this.showDataSource(!!archivedData, formattedDate);
        }

        // Êõ¥Êñ∞Áµ±Ë®à‰ø°ÊÅØ
        updateStats(transactions, summary = null) {
          let totalIncome, totalFixed, totalExpense, totalSpending, balance;

          if (summary) {
            // ‰ΩøÁî®Ê≠∏Ê™îÁöÑÁµ±Ë®àÊï∏Êìö
            totalIncome = summary.totalIncome;
            totalFixed = summary.totalFixed;
            totalExpense = summary.totalExpense;
            totalSpending = summary.totalSpending;
            balance = summary.balance;
          } else {
            // ÂØ¶ÊôÇË®àÁÆóÁµ±Ë®àÊï∏Êìö
            totalIncome = transactions
              .filter((t) => t.type === "income")
              .reduce((sum, t) => sum + t.amount, 0);

            totalFixed = transactions
              .filter((t) => t.type === "fixed_expense")
              .reduce((sum, t) => sum + t.amount, 0);

            totalExpense = transactions
              .filter((t) => t.type === "expense")
              .reduce((sum, t) => sum + t.amount, 0);

            totalSpending = totalFixed + totalExpense;
            balance = totalIncome - totalSpending;
          }

          // Ë®àÁÆóÁôæÂàÜÊØî
          let fixedPercentage = 0;
          let expensePercentage = 0;

          if (totalSpending > 0) {
            fixedPercentage = Math.round((totalFixed / totalSpending) * 100);
            expensePercentage = Math.round(
              (totalExpense / totalSpending) * 100
            );
          }

          // Êõ¥Êñ∞È°ØÁ§∫
          document.getElementById(
            "daily-income"
          ).textContent = `$${totalIncome.toFixed(2)}`;
          document.getElementById(
            "daily-fixed"
          ).textContent = `$${totalFixed.toFixed(2)}`;
          document.getElementById(
            "daily-expense"
          ).textContent = `$${totalExpense.toFixed(2)}`;
          document.getElementById(
            "daily-spending-total"
          ).textContent = `$${totalSpending.toFixed(2)}`;
          document.getElementById(
            "daily-balance"
          ).textContent = `$${balance.toFixed(2)}`;

          // Êõ¥Êñ∞ÁôæÂàÜÊØî
          document.getElementById(
            "fixed-percentage"
          ).textContent = `${fixedPercentage}%`;
          document.getElementById(
            "expense-percentage"
          ).textContent = `${expensePercentage}%`;

          // Ê†πÊìöÁµêÈ§òË®≠ÁΩÆÈ°èËâ≤
          const balanceElement = document.getElementById("daily-balance");
          if (balance > 0) {
            balanceElement.style.color = "#28a745";
          } else if (balance < 0) {
            balanceElement.style.color = "#dc3545";
          } else {
            balanceElement.style.color = "#666";
          }

          // Ê∂àË≤ªÁ∏ΩÈ°çÂç°ÁâáÂòÖÈ°èËâ≤Ë®≠ÁΩÆ
          const spendingElement = document.getElementById(
            "daily-spending-total"
          );
          if (totalSpending > 0) {
            spendingElement.style.color = "#6f42c1";
          } else {
            spendingElement.style.color = "#666";
          }
        }

        // Êõ¥Êñ∞Ë°®Ê†º
        updateTable(transactions, date) {
          const tbody = document.getElementById("transactions-body");

          if (transactions.length === 0) {
            tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="empty-state">
                                üìù ${date} Ê≤íÊúâ‰∫§ÊòìË®òÈåÑ
                            </td>
                        </tr>
                    `;
            return;
          }

          // ÊåâÊôÇÈñìÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÈù¢Ôºâ
          transactions.sort((a, b) => {
            // Â¶ÇÊûúÊúâÊôÇÈñì‰ø°ÊÅØÂ∞±ÊåâÊôÇÈñìÊéíÂ∫èÔºåÂê¶ÂâáÊåâIDÊéíÂ∫è
            if (a.timestamp && b.timestamp) {
              return new Date(b.timestamp) - new Date(a.timestamp);
            }
            return b.id - a.id;
          });

          tbody.innerHTML = transactions
            .map((transaction) => {
              const typeText =
                {
                  income: "üí∞ Êî∂ÂÖ•",
                  fixed_expense: "üè† Âõ∫ÂÆöÈñãÊîØ",
                  expense: "üí∏ ÂÖ∂‰ªñÈñãÊîØ",
                }[transaction.type] || transaction.type;

              const typeClass =
                {
                  income: "type-income",
                  fixed_expense: "type-fixed",
                  expense: "type-expense",
                }[transaction.type] || "";

              // Ê†ºÂºèÂåñÊôÇÈñìÈ°ØÁ§∫ÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
              let timeDisplay = transaction.date;
              if (transaction.timestamp) {
                const time = new Date(transaction.timestamp).toLocaleTimeString(
                  "zh-HK"
                );
                timeDisplay = `${transaction.date} ${time}`;
              }

              return `
                        <tr>
                            <td>${timeDisplay}</td>
                            <td><span class="type-badge ${typeClass}">${typeText}</span></td>
                            <td>${transaction.category}</td>
                            <td>${transaction.description}</td>
                            <td style="font-weight: bold; color: ${
                              transaction.type === "income"
                                ? "#28a745"
                                : "#dc3545"
                            }">
                                ${
                                  transaction.type === "income" ? "+" : "-"
                                }$${transaction.amount.toFixed(2)}
                            </td>
                        </tr>
                    `;
            })
            .join("");
        }

        // Êõ¥Êñ∞ÂàÜÈ†ÅÊéßÂà∂
        updatePagination(date) {
          const pagination = document.getElementById("pagination");
          const display = document.getElementById("current-date-display");

          const today = new Date();
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);

          // Â¶ÇÊûúÈÅ∏ÊìáÁöÑÊó•Êúü‰∏çÊòØ‰ªäÂ§©ÔºåÈ°ØÁ§∫ÂàÜÈ†ÅÊéßÂà∂
          if (date.toDateString() !== today.toDateString()) {
            pagination.style.display = "block";
            display.textContent = date.toLocaleDateString("zh-HK", {
              year: "numeric",
              month: "long",
              day: "numeric",
              weekday: "long",
            });
          } else {
            pagination.style.display = "none";
          }
        }

        // Ââç‰∏ÄÂ§©
        previousDay() {
          const newDate = new Date(this.currentDate);
          newDate.setDate(newDate.getDate() - 1);
          this.setDateToInput(newDate);
          this.displayDailyReport(newDate);
        }

        // Âæå‰∏ÄÂ§©
        nextDay() {
          const newDate = new Date(this.currentDate);
          newDate.setDate(newDate.getDate() + 1);

          // ‰∏çËÉΩÈÅ∏ÊìáÊú™‰æÜÁöÑÊó•Êúü
          const today = new Date();
          if (newDate <= today) {
            this.setDateToInput(newDate);
            this.displayDailyReport(newDate);
          } else {
            alert("‰∏çËÉΩÊü•ÁúãÊú™‰æÜÁöÑË®òÈåÑ");
          }
        }

        // È°ØÁ§∫Êï∏Êìö‰æÜÊ∫êÊèêÁ§∫
        showDataSource(isArchived, date) {
          // ÁßªÈô§ÁèæÊúâÊèêÁ§∫
          const existingHint = document.getElementById("data-source-hint");
          if (existingHint) {
            existingHint.remove();
          }

          const hint = document.createElement("div");
          hint.id = "data-source-hint";
          hint.style.cssText = `
                    text-align: center;
                    margin: 10px 0;
                    padding: 8px;
                    border-radius: 5px;
                    font-size: 14px;
                    background: ${isArchived ? "#d4edda" : "#fff3cd"};
                    color: ${isArchived ? "#155724" : "#856404"};
                    border: 1px solid ${isArchived ? "#c3e6cb" : "#ffeaa7"};
                `;

          if (isArchived) {
            hint.innerHTML = `üìÅ È°ØÁ§∫Ê≠∏Ê™îÊï∏Êìö (${date}) - Ê≠§Êó•ÊúüÂ∑≤ÂÆåÊàêÊó•Áµê`;
          } else {
            hint.innerHTML = `üîç È°ØÁ§∫Áï∂ÂâçÊï∏Êìö (${date}) - Ê≠§Êó•ÊúüÂ∞öÊú™Êó•Áµê`;
          }

          // ÊèíÂÖ•Âà∞ÊéßÂà∂ÂçÄÂüüÂæåÈù¢
          const controls = document.querySelector(".controls");
          controls.parentNode.insertBefore(hint, controls.nextSibling);
        }

        // ÁØ©ÈÅ∏‰∫§ÊòìË®òÈåÑ
        filterTransactions(filterType) {
          this.currentFilter = filterType;

          // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
          document.querySelectorAll(".filter-buttons button").forEach((btn) => {
            btn.classList.remove("active");
          });
          event.target.classList.add("active");

          // ÈáçÊñ∞È°ØÁ§∫Áï∂ÂâçÊó•ÊúüÂòÖË®òÈåÑÔºàÊúÉËá™ÂãïÊáâÁî®ÁØ©ÈÅ∏Ôºâ
          this.displayDailyReport(this.currentDate);
        }

        // Âä†ËºâÊúà‰ªΩÂ†±Âëä
        loadMonthlyReport() {
          const monthInput = document.getElementById("report-month").value;
          if (!monthInput) {
            alert("Ë´ãÈÅ∏ÊìáÊúà‰ªΩ");
            return;
          }

          this.displayMonthlyReport(monthInput);
        }

        // Âä†ËºâÊú¨ÊúàË®òÈåÑ
        loadCurrentMonth() {
          const now = new Date();
          const currentMonth = `${now.getFullYear()}-${String(
            now.getMonth() + 1
          ).padStart(2, "0")}`;
          document.getElementById("report-month").value = currentMonth;
          this.displayMonthlyReport(currentMonth);
        }

        // Âä†Ëºâ‰∏äÊúàË®òÈåÑ
        loadLastMonth() {
          const now = new Date();
          now.setMonth(now.getMonth() - 1);
          const lastMonth = `${now.getFullYear()}-${String(
            now.getMonth() + 1
          ).padStart(2, "0")}`;
          document.getElementById("report-month").value = lastMonth;
          this.displayMonthlyReport(lastMonth);
        }

        // È°ØÁ§∫Êúà‰ªΩÂ†±Âëä
        displayMonthlyReport(month) {
          const username =
            JSON.parse(localStorage.getItem("currentUser"))?.username ||
            "default";

          // Áç≤ÂèñÊâÄÊúâ‰∫§ÊòìË®òÈåÑ
          let allTransactions = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(`transactions-${username}-`)) {
              const transactions = JSON.parse(localStorage.getItem(key)) || [];
              allTransactions = allTransactions.concat(transactions);
            }
          }

          // ÈÅéÊøæÊåáÂÆöÊúà‰ªΩÁöÑË®òÈåÑ
          const monthlyTransactions = allTransactions.filter((t) =>
            t.date.startsWith(month)
          );

          // ÊåâÊó•ÊúüÂàÜÁµÑ
          const transactionsByDate = {};
          monthlyTransactions.forEach((transaction) => {
            if (!transactionsByDate[transaction.date]) {
              transactionsByDate[transaction.date] = [];
            }
            transactionsByDate[transaction.date].push(transaction);
          });

          // Êõ¥Êñ∞Êúà‰ªΩÁµ±Ë®à‰ø°ÊÅØ
          this.updateMonthlyStats(monthlyTransactions, month);

          // Êõ¥Êñ∞Êúà‰ªΩË°®Ê†º
          this.updateMonthlyTable(transactionsByDate, month);

          // Èö±ËóèÂàÜÈ†ÅÊéßÂà∂
          document.getElementById("pagination").style.display = "none";

          // È°ØÁ§∫Êï∏Êìö‰æÜÊ∫êÊèêÁ§∫
          this.showDataSource(false, `${month} Êúà‰ªΩ`);
        }

        // Êõ¥Êñ∞Êúà‰ªΩÁµ±Ë®à‰ø°ÊÅØ
        updateMonthlyStats(transactions, month) {
          const totalIncome = transactions
            .filter((t) => t.type === "income")
            .reduce((sum, t) => sum + t.amount, 0);

          const totalFixed = transactions
            .filter((t) => t.type === "fixed_expense")
            .reduce((sum, t) => sum + t.amount, 0);

          const totalExpense = transactions
            .filter((t) => t.type === "expense")
            .reduce((sum, t) => sum + t.amount, 0);

          const totalSpending = totalFixed + totalExpense;
          const balance = totalIncome - totalSpending;

          // Ë®àÁÆóÊØèÊó•Âπ≥Âùá
          const uniqueDates = [...new Set(transactions.map((t) => t.date))];
          const daysCount = uniqueDates.length;

          const avgIncome = daysCount > 0 ? totalIncome / daysCount : 0;
          const avgSpending = daysCount > 0 ? totalSpending / daysCount : 0;

          // Ë®àÁÆóÁôæÂàÜÊØî
          let fixedPercentage = 0;
          let expensePercentage = 0;

          if (totalSpending > 0) {
            fixedPercentage = Math.round((totalFixed / totalSpending) * 100);
            expensePercentage = Math.round(
              (totalExpense / totalSpending) * 100
            );
          }

          // Êõ¥Êñ∞È°ØÁ§∫
          document.getElementById(
            "daily-income"
          ).textContent = `$${totalIncome.toFixed(2)}`;
          document.getElementById(
            "daily-fixed"
          ).textContent = `$${totalFixed.toFixed(2)}`;
          document.getElementById(
            "daily-expense"
          ).textContent = `$${totalExpense.toFixed(2)}`;
          document.getElementById(
            "daily-spending-total"
          ).textContent = `$${totalSpending.toFixed(2)}`;
          document.getElementById(
            "daily-balance"
          ).textContent = `$${balance.toFixed(2)}`;

          // Êõ¥Êñ∞ÁôæÂàÜÊØî
          document.getElementById(
            "fixed-percentage"
          ).textContent = `${fixedPercentage}%`;
          document.getElementById(
            "expense-percentage"
          ).textContent = `${expensePercentage}%`;

          // Ê∑ªÂä†Êúà‰ªΩÁµ±Ë®à‰ø°ÊÅØ
          const existingMonthStats = document.getElementById("monthly-stats");
          if (existingMonthStats) {
            existingMonthStats.remove();
          }

          const monthStats = document.createElement("div");
          monthStats.id = "monthly-stats";
          monthStats.style.cssText = `
                    background: #e8f4fd;
                    padding: 15px;
                    border-radius: 8px;
                    margin: 15px 0;
                    border-left: 4px solid #2196F3;
                `;
          monthStats.innerHTML = `
                    <h3 style="margin: 0 0 10px 0; color: #1976D2;">üìà ${month} Êúà‰ªΩÁµ±Ë®à</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div>
                            <strong>‰∫§ÊòìÂ§©Êï∏:</strong> ${daysCount} Â§©
                        </div>
                        <div>
                            <strong>Á∏Ω‰∫§ÊòìÊï∏:</strong> ${transactions.length} Á≠Ü
                        </div>
                        <div>
                            <strong>Êó•ÂùáÊî∂ÂÖ•:</strong> $${avgIncome.toFixed(2)}
                        </div>
                        <div>
                            <strong>Êó•ÂùáÊîØÂá∫:</strong> $${avgSpending.toFixed(
                              2
                            )}
                        </div>
                    </div>
                `;

          // ÊèíÂÖ•Âà∞Áµ±Ë®àÂç°ÁâáÂæåÈù¢
          const statsCards = document.querySelector(".stats-cards");
          statsCards.parentNode.insertBefore(
            monthStats,
            statsCards.nextSibling
          );
        }

        // Êõ¥Êñ∞Êúà‰ªΩË°®Ê†º
        updateMonthlyTable(transactionsByDate, month) {
          const tbody = document.getElementById("transactions-body");

          const dates = Object.keys(transactionsByDate).sort().reverse(); // Êó•ÊúüÂÄíÂ∫èÊéíÂàó

          if (dates.length === 0) {
            tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="empty-state">
                                üìù ${month} Êúà‰ªΩÊ≤íÊúâ‰∫§ÊòìË®òÈåÑ
                            </td>
                        </tr>
                    `;
            return;
          }

          let tableHTML = "";

          dates.forEach((date) => {
            const dayTransactions = transactionsByDate[date];
            const dayIncome = dayTransactions
              .filter((t) => t.type === "income")
              .reduce((sum, t) => sum + t.amount, 0);
            const dayFixed = dayTransactions
              .filter((t) => t.type === "fixed_expense")
              .reduce((sum, t) => sum + t.amount, 0);
            const dayExpense = dayTransactions
              .filter((t) => t.type === "expense")
              .reduce((sum, t) => sum + t.amount, 0);
            const dayTotal = dayFixed + dayExpense;
            const dayBalance = dayIncome - dayTotal;

            // Êó•ÊúüÊ®ôÈ°åË°å
            tableHTML += `
                        <tr style="background: #f1f8ff;">
                            <td colspan="5" style="font-weight: bold; padding: 12px;">
                                üìÖ ${date} 
                                <span style="float: right; font-size: 14px; font-weight: normal;">
                                    Êî∂ÂÖ•: <span style="color: #28a745;">$${dayIncome.toFixed(
                                      2
                                    )}</span> | 
                                    ÊîØÂá∫: <span style="color: #dc3545;">$${dayTotal.toFixed(
                                      2
                                    )}</span> | 
                                    ÁµêÈ§ò: <span style="color: ${
                                      dayBalance >= 0 ? "#28a745" : "#dc3545"
                                    }">$${dayBalance.toFixed(2)}</span>
                                </span>
                            </td>
                        </tr>
                    `;

            // Ë©≤Êó•ÊúüÂòÖ‰∫§ÊòìË®òÈåÑ
            dayTransactions.forEach((transaction) => {
              const typeText =
                {
                  income: "üí∞ Êî∂ÂÖ•",
                  fixed_expense: "üè† Âõ∫ÂÆöÈñãÊîØ",
                  expense: "üí∏ ÂÖ∂‰ªñÈñãÊîØ",
                }[transaction.type] || transaction.type;

              const typeClass =
                {
                  income: "type-income",
                  fixed_expense: "type-fixed",
                  expense: "type-expense",
                }[transaction.type] || "";

              let timeDisplay = transaction.date;
              if (transaction.timestamp) {
                const time = new Date(transaction.timestamp).toLocaleTimeString(
                  "zh-HK"
                );
                timeDisplay = `${transaction.date} ${time}`;
              }

              tableHTML += `
                            <tr>
                                <td>${timeDisplay}</td>
                                <td><span class="type-badge ${typeClass}">${typeText}</span></td>
                                <td>${transaction.category}</td>
                                <td>${transaction.description}</td>
                                <td style="font-weight: bold; color: ${
                                  transaction.type === "income"
                                    ? "#28a745"
                                    : "#dc3545"
                                }">
                                    ${
                                      transaction.type === "income" ? "+" : "-"
                                    }$${transaction.amount.toFixed(2)}
                                </td>
                            </tr>
                        `;
            });

            // Ê∑ªÂä†Á©∫Ë°åÂàÜÈöî
            tableHTML += `<tr style="height: 10px;"><td colspan="5"></td></tr>`;
          });

          tbody.innerHTML = tableHTML;
        }
      }

      // ÂàùÂßãÂåñÊØèÊó•Â†±Âëä
      const dailyReport = new DailyReport();
    </script>
  </body>
</html>
